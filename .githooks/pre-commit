#!/usr/bin/env bash
# Simple pre-commit hook to prevent committing .env files or obvious API keys
# Exit non-zero to block commit

set -euo pipefail

# Patterns to block
BLOCK_PATTERNS=("OPENAI_API_KEY" "sk-" ".env")

# Get list of files staged for commit
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [[ -z "$STAGED_FILES" ]]; then
  exit 0
fi

blocked=0
for file in $STAGED_FILES; do
  # only check text files
  if file "$file" | grep -q text; then
    for pattern in "${BLOCK_PATTERNS[@]}"; do
      if git grep -n --cached -I "${pattern}" -- "$file" > /dev/null 2>&1; then
        echo "ERROR: Attempt to commit file '$file' containing forbidden pattern: $pattern"
        blocked=1
      fi
    done
  fi
done

if [[ $blocked -ne 0 ]]; then
  echo "Commit blocked by pre-commit hook. Remove secrets and try again."
  exit 1
fi

exit 0
